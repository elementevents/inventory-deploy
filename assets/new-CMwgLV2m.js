import{c as P,aw as z,ax as G,ay as X,r as S,j as e,N as H,Q as Y,B as Z,U as J,V as ee,W as te,X as ne,L as se,Y as re,Z as ae,_ as ie,az as oe,x as ce,z as le,b as de,m as me,aA as ue,n as fe,aB as he,F as xe,o as I,p as F,q as k,v as w,t as M,I as pe,ap as ge}from"./index-DPT7YIch.js";import{t as ye}from"./zod-C1FoFPEG.js";import{B as O}from"./Button-BSLG-az_.js";import{a as je,I as B,b as $}from"./inventories-BJWKTBnS.js";import{C as D}from"./Combobox-CjoacOvs.js";import{u as ve,S as Q}from"./skeleton-B4IKsskW.js";import{F as be}from"./FormSkeleton-C9Jrq2rd.js";import{C as Ce}from"./chevrons-up-down-BL4WMhWk.js";import{a as Ne}from"./useBins-DQIQxjpf.js";import{u as Se}from"./useCount-C15s6mvI.js";import{q as K}from"./constants-CTS4Tt_R.js";import{a as _e,c as Ie}from"./countDetails-BLN5WjfT.js";import{u as we}from"./useMutation-BxO0WMH1.js";import{a as Te}from"./useUnits-C8Jujb0i.js";import{S as Le}from"./switch-nhuYrslr.js";import{T as qe}from"./textarea-BQNnX4_y.js";import"./bins-CT9JJK-D.js";import"./counts-BRBGrJXr.js";import"./units-D6rEUwzt.js";/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=P("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);function ke(t){var n=typeof t;return t!=null&&(n=="object"||n=="function")}var R=ke,Ae=z,Ee=function(){return Ae.Date.now()},Be=Ee,$e=/\s/;function Me(t){for(var n=t.length;n--&&$e.test(t.charAt(n)););return n}var Oe=Me,De=Oe,Qe=/^\s+/;function We(t){return t&&t.slice(0,De(t)+1).replace(Qe,"")}var Ve=We;function Ue(t){return t!=null&&typeof t=="object"}var Ke=Ue,Re=G,Pe=Ke,ze="[object Symbol]";function Ge(t){return typeof t=="symbol"||Pe(t)&&Re(t)==ze}var Xe=Ge,He=Ve,W=R,Ye=Xe,V=NaN,Ze=/^[-+]0x[0-9a-f]+$/i,Je=/^0b[01]+$/i,et=/^0o[0-7]+$/i,tt=parseInt;function nt(t){if(typeof t=="number")return t;if(Ye(t))return V;if(W(t)){var n=typeof t.valueOf=="function"?t.valueOf():t;t=W(n)?n+"":n}if(typeof t!="string")return t===0?t:+t;t=He(t);var o=Je.test(t);return o||et.test(t)?tt(t.slice(2),o?2:8):Ze.test(t)?V:+t}var st=nt,rt=R,E=Be,U=st,at="Expected a function",it=Math.max,ot=Math.min;function ct(t,n,o){var c,u,a,s,i,f,d=0,g=!1,x=!1,y=!0;if(typeof t!="function")throw new TypeError(at);n=U(n)||0,rt(o)&&(g=!!o.leading,x="maxWait"in o,a=x?it(U(o.maxWait)||0,n):a,y="trailing"in o?!!o.trailing:y);function j(h){var C=c,_=u;return c=u=void 0,d=h,s=t.apply(_,C),s}function v(h){return d=h,i=setTimeout(p,n),g?j(h):s}function m(h){var C=h-f,_=h-d,N=n-C;return x?ot(N,a-_):N}function r(h){var C=h-f,_=h-d;return f===void 0||C>=n||C<0||x&&_>=a}function p(){var h=E();if(r(h))return b(h);i=setTimeout(p,m(h))}function b(h){return i=void 0,y&&c?j(h):(c=u=void 0,s)}function T(){i!==void 0&&clearTimeout(i),d=0,c=f=u=i=void 0}function L(){return i===void 0?s:b(E())}function q(){var h=E(),C=r(h);if(c=arguments,u=this,f=h,C){if(i===void 0)return v(f);if(x)return clearTimeout(i),i=setTimeout(p,n),j(f)}return i===void 0&&(i=setTimeout(p,n)),s}return q.cancel=T,q.flush=L,q}var lt=ct;const dt=X(lt),mt=t=>{if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const o=n[n.length-1],c=parseInt(o,10);return Number.isNaN(c)?null:String(c)},ut=t=>{if(!t)return null;const n=t.match(/-(\d+)$/);if(!n)return null;const o=parseInt(n[1],10);return Number.isNaN(o)?null:String(o)};function ft(t,n){const o=mt(n),c=t.map(s=>{const i=ut(s.id);return{...s,_idStoreCode:i,_isActiveNum:s.is_active?1:0,_quantityNum:s.quantity}}),u=new Map;for(const s of c){const i=s.header_code;u.has(i)||u.set(i,[]),u.get(i).push(s)}const a=Array.from(u.entries()).map(([s,i])=>{const f=o?i.filter(j=>j._idStoreCode===o):[];let d,g=!1,x=0;return f.length>0?(f.sort((j,v)=>v._quantityNum-j._quantityNum),d=f[0],g=!0,x=d._quantityNum):(d=i.find(v=>v.id===s)??i[0],g=!1,x=0),{row:{...d,header_code:s,quantity:g?d._quantityNum:0,storeMatch:g},sortKey:[g?1:0,d._isActiveNum,x,(d.name??"").toString(),s]}});return a.sort((s,i)=>{const[f,d,g,x,y]=s.sortKey,[j,v,m,r,p]=i.sortKey;if(j!==f)return j-f;if(v!==d)return v-d;if(m!==g)return m-g;const b=x.localeCompare(r);return b!==0?b:y.localeCompare(p)}),a.map(s=>s.row)}function ht({countType:t,onValueChange:n,storeName:o,value:c}){const[u,a]=S.useState(!1),[s,i]=S.useState(""),[f,d]=S.useState([]),[g,x]=S.useState(!1),y=S.useMemo(()=>dt(async(m,r)=>{x(!0);try{const p=await je(m,r),b=ft(p,o);d(b)}catch(p){console.error("Error fetching inventory:",p)}finally{x(!1)}},500),[]);S.useEffect(()=>(y(t,s),()=>{y.cancel()}),[t,s,y]);const j=()=>{const m="Select inventory...";if(!c)return m;const r=f.find(p=>p.id===c);return r?e.jsxs("div",{className:"flex items-center",children:[e.jsx(B,{alt:r.name,className:"w-12 h-12 rounded-sm bg-gray-200",src:$(r.id)}),e.jsx("span",{className:"ml-2",children:e.jsxs("div",{className:"text-left",children:[e.jsx("p",{children:r.name}),e.jsx("p",{className:"text-gray-400 text-xs font-mono",children:r.id})]})})]}):m},v=()=>g?e.jsxs("div",{className:"p-2 flex items-center",children:[e.jsx(se,{className:"h-4 w-4 animate-spin mr-1"}),"Loading..."]}):f.length===0?e.jsx(re,{children:"No inventory found."}):e.jsx(ae,{children:f.map(m=>e.jsxs(ie,{value:m.id,onSelect:r=>{r!==c&&n(m),a(!1)},children:[e.jsx(oe,{className:ce("mr-2 h-4 w-4",c===m.id?"opacity-100":"opacity-0")}),e.jsx(B,{alt:m.name,className:"w-12 h-12 rounded-sm bg-gray-200",src:$(m.header_code)}),e.jsx("span",{className:"ml-2",children:e.jsxs("div",{className:"text-left",children:[e.jsx("p",{children:m.name}),e.jsx("p",{className:"text-gray-400 text-xs font-mono",children:m.id}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"text-gray-600",children:["Qty: ",m.quantity]}),m.storeMatch?e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700",children:o}):e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-gray-100 text-gray-700",children:"Other store"}),m.is_active===!1&&e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-amber-100 text-amber-700",children:"Inactive"})]})]})})]},m.id))});return e.jsxs(H,{open:u,onOpenChange:a,children:[e.jsx(Y,{asChild:!0,children:e.jsxs(Z,{variant:"outline",role:"combobox","aria-expanded":u,className:"w-full justify-between h-auto",children:[j(),e.jsx(Ce,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(J,{className:"w-[var(--radix-popover-trigger-width)] p-0",children:e.jsxs(ee,{shouldFilter:!1,children:[e.jsx(te,{placeholder:"Search inventory...",value:s,onValueChange:i}),e.jsx(ne,{children:v()})]})})]})}function xt(t){return ve({queryKey:K.countDetails.forCount(t),queryFn:()=>_e(t)})}function pt({onSuccess:t}){const n=le(),{toast:o}=de();return we({mutationFn:({countId:c,data:u,inventoryName:a,countStatus:s})=>Ie(c,u,a,s),onSuccess:()=>{n.invalidateQueries({queryKey:K.countDetails.all}),o({title:"Count detail created successfully!",description:"The count detail has been created."}),t()},onError:c=>{let u="Something went wrong!";(me(c)||c instanceof Error)&&(u=c.message),o({title:"Failed to create count detail!",description:u,variant:"destructive"})}})}function $t(){const{count:t}=ue.useSearch(),[n,o]=S.useState(null),[c,u]=S.useState(!1),{data:a,error:s,isLoading:i}=Se(t),{data:f,error:d,isLoading:g}=Ne(a==null?void 0:a.store.id,{enabled:!!a}),{data:x,error:y,isLoading:j}=Te(),{data:v}=xt(t),m=pt({onSuccess:()=>{o(null),p({...r.getValues(),quantity:void 0,comments:"",inventory_id:"",bin_id:""}),window.scrollTo({top:0,behavior:"smooth"})}}),r=fe({defaultValues:{quantity:void 0,comments:"",is_damaged:!1,inventory_id:"",bin_id:"",unit_id:""},resolver:ye(he)}),{reset:p,watch:b}=r,T=b("bin_id"),L=b("inventory_id");S.useEffect(()=>{var N;x&&p({...r.getValues(),unit_id:(N=x.find(l=>l.is_default))==null?void 0:N.id})},[x,p]),S.useEffect(()=>{if(T&&L&&v){const N=v.some(l=>l.bin.id===T&&l.inventory_id===L&&l.count.id===t);u(N)}else u(!1)},[T,L,v]);async function q(N){!a||!n||await m.mutateAsync({countId:a.id,data:N,inventoryName:n.name,countStatus:a.status})}function h(){p({...r.getValues(),bin_id:"",comments:"",inventory_id:"",is_damaged:!1,quantity:void 0}),o(null)}const C=()=>a?e.jsx("h3",{className:"text-2xl font-semibold leading-none tracking-tight",children:`Add Count Detail (${a.name} | ${a.status})`}):e.jsx(Q,{className:"w-52 h-8 rounded-md"}),_=()=>g||j||i||!a?e.jsx(be,{}):d||y||s?e.jsxs("p",{className:"text-center text-red-500",children:["Error:"," ",(d==null?void 0:d.message)||(y==null?void 0:y.message)||(s==null?void 0:s.message)]}):f?x?e.jsx(xe,{...r,children:e.jsxs("form",{className:"max-w-2xl",onSubmit:r.handleSubmit(q),children:[e.jsx("div",{className:"w-full grid gap-2",children:e.jsx(I,{control:r.control,name:"bin_id",render:({field:l})=>e.jsxs(F,{children:[e.jsx(k,{children:"Bin"}),e.jsx(D,{items:f??[],onValueChange:l.onChange,placeholder:"Select a bin",value:l.value}),e.jsx(w,{})]})})}),e.jsxs("div",{className:"w-full grid gap-2 mt-4",children:[e.jsx(I,{control:r.control,name:"inventory_id",render:({field:l})=>e.jsxs(F,{children:[e.jsx(k,{children:"Inventory"}),e.jsx(ht,{countType:a.count_type.id,onValueChange:A=>{o(A),l.onChange(A.id)},storeName:a.store.name,value:l.value}),e.jsx(w,{})]})}),c&&e.jsxs("div",{className:"mt-2 flex items-center text-red-600",children:[e.jsx(Fe,{className:"mr-2 h-5 w-5"}),e.jsx("p",{children:"Warning: This item has already been counted in the same bin!"})]})]}),n&&e.jsx(B,{alt:"preview inventory image",className:"mt-4 w-56 h-56 bg-gray-200",src:$(n.header_code)}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:r.control,name:"quantity",render:({field:l})=>e.jsxs(F,{className:"w-full",children:[e.jsx(k,{children:"Quantity"}),e.jsx(M,{children:e.jsx(pe,{placeholder:"Quantity",type:"number",...l,value:l.value??"",onChange:A=>l.onChange(A.target.valueAsNumber),required:!0})}),e.jsx(w,{})]})})}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:r.control,name:"unit_id",render:({field:l})=>e.jsxs(F,{children:[e.jsx(k,{children:"Unit"}),e.jsx(D,{items:x??[],onValueChange:l.onChange,placeholder:"Select a unit",value:l.value}),e.jsx(w,{})]})})}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:r.control,name:"comments",render:({field:l})=>e.jsxs(F,{children:[e.jsx(k,{children:"Comments"}),e.jsx(qe,{placeholder:"Comments",...l,onChange:l.onChange}),e.jsx(w,{})]})})}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:r.control,name:"is_damaged",render:({field:l})=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{children:e.jsx(Le,{checked:l.value,onCheckedChange:l.onChange})}),e.jsx(ge,{className:"ml-1",htmlFor:"is_damaged",children:"is damaged"}),e.jsx(w,{})]})})}),e.jsxs("div",{className:"w-full flex gap-2 mt-8",children:[e.jsx(O,{disabled:r.formState.isSubmitting,label:"Clear",onClick:h,variant:"outline"}),e.jsx(O,{className:"w-full",isLoading:r.formState.isSubmitting,label:"Save",loadingLabel:"Saving...",type:"submit"})]})]})}):e.jsx("p",{className:"text-red-500",children:"Can't fetch units data."}):e.jsx("p",{className:"text-red-500",children:"Can't fetch bins data."});return e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[C(),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Create a new count detail."}),a?e.jsx("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700",children:a.store.name})}):e.jsx(Q,{className:"w-40 h-4 rounded-md"})]})}),e.jsx("div",{children:_()})]})}export{$t as component};
