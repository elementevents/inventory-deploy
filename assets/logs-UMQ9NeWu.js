import{s as x,j as a,y,d as _,R as j}from"./index-CJiv-3wc.js";import{D as u,a as g,q as w}from"./constants-CRsvxbNR.js";import{e as S}from"./exportAllServerSide-BTqq3Xc6.js";import{G as v}from"./GenericDataDisplay-BIC15-bw.js";import{D as i,u as b,s as N,a as D}from"./tableSortMapper-BiGW34eV.js";import{u as C}from"./skeleton-DqkA8ofe.js";import{U as E}from"./user-CIUoFgt3.js";import"./download-Bq5cVHz3.js";import"./circle-plus-BUaaUO2Z.js";async function K({pageIndex:e=u,pageSize:t=g,q:s,sortBy:n}){const l=e*t,c=l+t-1;let r=x.from("audit_logs").select(`
    id,
    table_name,
    record_id,
    operation,
    old_data,
    new_data,
    changed_at,
    user:changed_by (
        id,
        email,
        employee_number,
        first_name,
        last_name
    )
  `,{count:"exact"}).range(l,c);s&&s.trim()&&(r=r.or(`table_name.ilike.%${s}%,record_id.ilike.%${s}%,operation.ilike.%${s}%`)),n&&n.length>0?n.split(",").forEach(p=>{const[f,h]=p.split(".");r=r.order(f,{ascending:h==="asc"})}):r=r.order("changed_at",{ascending:!1});const{data:d,error:o,count:m}=await r.overrideTypes();if(o)throw o;return{result:d,total:m??0}}function A(e){return C({queryKey:w.logs.list(e),queryFn:()=>K(e)})}const T=[{accessorKey:"table_name",header:({column:e})=>a.jsx(i,{column:e,title:"Table name"}),cell:({row:e})=>a.jsx("div",{className:"font-medium",children:e.getValue("table_name")})},{accessorKey:"record_id",header:({column:e})=>a.jsx(i,{column:e,title:"Record ID"}),cell:({row:e})=>a.jsx("div",{className:"max-w-[200px] truncate font-medium",children:e.getValue("record_id")})},{accessorKey:"operation",header:({column:e})=>a.jsx(i,{column:e,title:"Operation"}),cell:({row:e})=>a.jsx("div",{className:"font-medium",children:e.getValue("operation")})},{accessorKey:"old_data",header:({column:e})=>a.jsx(i,{column:e,title:"Old data"}),cell:({row:e})=>{const t=e.getValue("old_data"),s=t?JSON.stringify(t,void 0,2):"--";return a.jsx("code",{className:"block font-mono whitespace-pre overflow-x-scroll",children:s})}},{accessorKey:"new_data",header:({column:e})=>a.jsx(i,{column:e,title:"New data"}),cell:({row:e})=>{const t=e.getValue("new_data");return a.jsx("code",{className:"block font-mono whitespace-pre overflow-x-scroll",children:JSON.stringify(t,void 0,2)})}},{accessorKey:"changed_at",header:({column:e})=>a.jsx(i,{column:e,title:"Change date"}),cell:({row:e})=>a.jsx("div",{className:"max-w-[150px] truncate font-medium",children:y(e.getValue("changed_at"),"MMM dd, yyyy h:mma")})},{accessorKey:"user",header:({column:e})=>a.jsx(i,{column:e,title:"Changed by"}),cell:({row:e})=>{const t=e.getValue("user");return a.jsxs("div",{className:"flex items-center font-medium",children:[a.jsx(E,{className:"h-3.5 w-3.5 mr-1"}),t?`${t.first_name} ${t.last_name}`:"System"]})}}];function U(){const{user:e}=_(),{filters:t,setFilters:s}=b(j.id),{data:n,isLoading:l}=A(t),c={pageIndex:t.pageIndex??u,pageSize:t.pageSize??g},r=N(t.sortBy);if(e===null)return a.jsx("div",{});const d=["admin"].includes(e.role);return a.jsx(v,{allowExport:d,columns:T,data:n,description:"Search your logs.",filterPlaceholder:"Search logs...",isLoading:l,searchValue:t.q??"",onExportClick:async()=>S("logs"),onSearchFieldChange:o=>{s({q:o,pageIndex:0})},onSortingChange:o=>{const m=typeof o=="function"?o(r):o;return s({sortBy:D(m)})},pagination:c,paginationOptions:{onPaginationChange:o=>{s(typeof o=="function"?o(c):o)},rowCount:n==null?void 0:n.total},sorting:r,title:"Logs"})}export{U as component};
