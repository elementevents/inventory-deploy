import{c as z,aw as G,ax as X,ay as H,r as N,j as e,N as Y,Q as Z,B as J,U as ee,V as te,W as ne,X as re,L as se,Y as ae,Z as ie,_ as oe,az as ce,x as le,z as de,b as me,m as ue,aA as fe,n as xe,aB as he,F as pe,o as I,p as F,q as k,v as w,t as O,I as ge,ap as ye}from"./index-D0UzDXdb.js";import{t as je}from"./zod-fFyjxTVb.js";import{B as D}from"./Button-fnRQMAsf.js";import{a as ve,I as $,b as M}from"./inventories-CGpNHGHb.js";import{C as Q}from"./Combobox-DPvqx9Jo.js";import{u as be,S as W}from"./skeleton-DTNZejXw.js";import{F as Ce}from"./FormSkeleton-WB0KD9eA.js";import{C as Ne}from"./chevrons-up-down-BGID-bGd.js";import{a as Se}from"./useBins-D6XcTMju.js";import{u as _e}from"./useCount-B5Xn7iEM.js";import{q as R}from"./constants-BmjxfpbN.js";import{a as Ie,c as we}from"./countDetails-DIZAr2xK.js";import{u as Te}from"./useMutation-Dl_MGIkD.js";import{a as Le}from"./useUnits-B2kkQonB.js";import{S as qe}from"./switch-JFT-bvvN.js";import{T as Fe}from"./textarea-Da9uh_Zs.js";import"./bins-Caat3Lr0.js";import"./counts-SqIoWuzr.js";import"./units-BmqAMdNn.js";/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=z("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);function Ae(t){var n=typeof t;return t!=null&&(n=="object"||n=="function")}var P=Ae,Ee=G,Be=function(){return Ee.Date.now()},$e=Be,Me=/\s/;function Oe(t){for(var n=t.length;n--&&Me.test(t.charAt(n)););return n}var De=Oe,Qe=De,We=/^\s+/;function Ve(t){return t&&t.slice(0,Qe(t)+1).replace(We,"")}var Ue=Ve;function Ke(t){return t!=null&&typeof t=="object"}var Re=Ke,Pe=X,ze=Re,Ge="[object Symbol]";function Xe(t){return typeof t=="symbol"||ze(t)&&Pe(t)==Ge}var He=Xe,Ye=Ue,V=P,Ze=He,U=NaN,Je=/^[-+]0x[0-9a-f]+$/i,et=/^0b[01]+$/i,tt=/^0o[0-7]+$/i,nt=parseInt;function rt(t){if(typeof t=="number")return t;if(Ze(t))return U;if(V(t)){var n=typeof t.valueOf=="function"?t.valueOf():t;t=V(n)?n+"":n}if(typeof t!="string")return t===0?t:+t;t=Ye(t);var o=et.test(t);return o||tt.test(t)?nt(t.slice(2),o?2:8):Je.test(t)?U:+t}var st=rt,at=P,B=$e,K=st,it="Expected a function",ot=Math.max,ct=Math.min;function lt(t,n,o){var c,f,h,r,a,l,m=0,g=!1,i=!1,y=!0;if(typeof t!="function")throw new TypeError(it);n=K(n)||0,at(o)&&(g=!!o.leading,i="maxWait"in o,h=i?ot(K(o.maxWait)||0,n):h,y="trailing"in o?!!o.trailing:y);function j(x){var C=c,_=f;return c=f=void 0,m=x,r=t.apply(_,C),r}function v(x){return m=x,a=setTimeout(p,n),g?j(x):r}function u(x){var C=x-l,_=x-m,A=n-C;return i?ct(A,h-_):A}function s(x){var C=x-l,_=x-m;return l===void 0||C>=n||C<0||i&&_>=h}function p(){var x=B();if(s(x))return b(x);a=setTimeout(p,u(x))}function b(x){return a=void 0,y&&c?j(x):(c=f=void 0,r)}function T(){a!==void 0&&clearTimeout(a),m=0,c=l=f=a=void 0}function L(){return a===void 0?r:b(B())}function q(){var x=B(),C=s(x);if(c=arguments,f=this,l=x,C){if(a===void 0)return v(l);if(i)return clearTimeout(a),a=setTimeout(p,n),j(l)}return a===void 0&&(a=setTimeout(p,n)),r}return q.cancel=T,q.flush=L,q}var dt=lt;const mt=H(dt),ut=t=>{if(!t)return null;const n=t.match(/(\d+)/g);if(!n||n.length===0)return null;const o=n[n.length-1],c=parseInt(o,10);return Number.isNaN(c)?null:String(c)},ft=t=>{if(!t)return null;const n=t.match(/-(\d+)$/);if(!n)return null;const o=parseInt(n[1],10);return Number.isNaN(o)?null:String(o)};function xt(t,n){const o=ut(n),c=t.map(r=>{const a=ft(r.id);return{...r,_idStoreCode:a,_isActiveNum:r.is_active?1:0,_quantityNum:r.quantity}}),f=new Map;for(const r of c){const a=r.header_code;f.has(a)||f.set(a,[]),f.get(a).push(r)}const h=Array.from(f.entries()).map(([r,a])=>{const l=o?a.filter(j=>j._idStoreCode===o):[];let m,g=!1,i=0;return l.length>0?(l.sort((j,v)=>v._quantityNum-j._quantityNum),m=l[0],g=!0,i=m._quantityNum):(m=a.find(v=>v.id===r)??a[0],g=!1,i=0),{row:{...m,header_code:r,quantity:g?m._quantityNum:0,storeMatch:g},sortKey:[g?1:0,m._isActiveNum,i,(m.name??"").toString(),r]}});return h.sort((r,a)=>{const[l,m,g,i,y]=r.sortKey,[j,v,u,s,p]=a.sortKey;if(j!==l)return j-l;if(v!==m)return v-m;if(u!==g)return u-g;const b=i.localeCompare(s);return b!==0?b:y.localeCompare(p)}),h.map(r=>r.row)}function ht({countType:t,onValueChange:n,storeName:o,value:c}){const[f,h]=N.useState(!1),[r,a]=N.useState(""),[l,m]=N.useState([]),[g,i]=N.useState(!1),y=N.useMemo(()=>mt(async(u,s)=>{i(!0);try{const p=await ve(u,s),b=xt(p,o);m(b)}catch(p){console.error("Error fetching inventory:",p)}finally{i(!1)}},500),[]);N.useEffect(()=>(y(t,r),()=>{y.cancel()}),[t,r,y]);const j=()=>{const u="Select inventory...";if(!c)return u;const s=l.find(p=>p.id===c);return s?e.jsxs("div",{className:"flex items-center",children:[e.jsx($,{alt:s.name,className:"w-12 h-12 rounded-sm bg-gray-200",src:M(s.id)}),e.jsx("span",{className:"ml-2",children:e.jsxs("div",{className:"text-left",children:[e.jsx("p",{children:s.name}),e.jsx("p",{className:"text-gray-400 text-xs font-mono",children:s.id})]})})]}):u},v=()=>g?e.jsxs("div",{className:"p-2 flex items-center",children:[e.jsx(se,{className:"h-4 w-4 animate-spin mr-1"}),"Loading..."]}):l.length===0?e.jsx(ae,{children:"No inventory found."}):e.jsx(ie,{children:l.map(u=>e.jsxs(oe,{value:u.id,onSelect:s=>{s!==c&&n(u),h(!1)},children:[e.jsx(ce,{className:le("mr-2 h-4 w-4",c===u.id?"opacity-100":"opacity-0")}),e.jsx($,{alt:u.name,className:"w-12 h-12 rounded-sm bg-gray-200",src:M(u.id)}),e.jsx("span",{className:"ml-2",children:e.jsxs("div",{className:"text-left",children:[e.jsx("p",{children:u.name}),e.jsx("p",{className:"text-gray-400 text-xs font-mono",children:u.id}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"text-gray-600",children:["Qty: ",u.quantity]}),u.storeMatch?e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700",children:o}):e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-gray-100 text-gray-700",children:"Other store"}),u.is_active===!1&&e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-amber-100 text-amber-700",children:"Inactive"})]})]})})]},u.id))});return e.jsxs(Y,{open:f,onOpenChange:h,children:[e.jsx(Z,{asChild:!0,children:e.jsxs(J,{variant:"outline",role:"combobox","aria-expanded":f,className:"w-full justify-between h-auto",children:[j(),e.jsx(Ne,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ee,{className:"w-[var(--radix-popover-trigger-width)] p-0",children:e.jsxs(te,{shouldFilter:!1,children:[e.jsx(ne,{placeholder:"Search inventory...",value:r,onValueChange:a}),e.jsx(re,{children:v()})]})})]})}function pt(t){return be({queryKey:R.countDetails.forCount(t),queryFn:()=>Ie(t)})}function gt({onSuccess:t}){const n=de(),{toast:o}=me();return Te({mutationFn:({countId:c,data:f,inventoryName:h,countStatus:r})=>we(c,f,h,r),onSuccess:()=>{n.invalidateQueries({queryKey:R.countDetails.all}),o({title:"Count detail created successfully!",description:"The count detail has been created."}),t()},onError:c=>{let f="Something went wrong!";(ue(c)||c instanceof Error)&&(f=c.message),o({title:"Failed to create count detail!",description:f,variant:"destructive"})}})}function Mt(){const{count:t}=fe.useSearch(),[n,o]=N.useState(null),[c,f]=N.useState(!1),{data:h,error:r,isLoading:a}=Se(),{data:l,error:m,isLoading:g}=Le(),{data:i,error:y,isLoading:j}=_e(t),{data:v}=pt(t),u=gt({onSuccess:()=>{o(null),p({...s.getValues(),quantity:void 0,comments:"",inventory_id:"",bin_id:""}),window.scrollTo({top:0,behavior:"smooth"})}}),s=xe({defaultValues:{quantity:void 0,comments:"",is_damaged:!1,inventory_id:"",bin_id:"",unit_id:""},resolver:je(he)}),{reset:p,watch:b}=s,T=b("bin_id"),L=b("inventory_id");N.useEffect(()=>{var S;l&&p({...s.getValues(),unit_id:(S=l.find(d=>d.is_default))==null?void 0:S.id})},[l,p]),N.useEffect(()=>{if(T&&L&&v){const S=v.some(d=>d.bin.id===T&&d.inventory_id===L&&d.count.id===t);f(S)}else f(!1)},[T,L,v]);async function q(S){!i||!n||await u.mutateAsync({countId:i.id,data:S,inventoryName:n.name,countStatus:i.status})}function x(){p({...s.getValues(),bin_id:"",comments:"",inventory_id:"",is_damaged:!1,quantity:void 0}),o(null)}const C=()=>h?i?h.filter(S=>S.store.id===i.store.id):h:[],_=()=>i?e.jsx("h3",{className:"text-2xl font-semibold leading-none tracking-tight",children:`Add Count Detail (${i.name} | ${i.status})`}):e.jsx(W,{className:"w-52 h-8 rounded-md"}),A=()=>a||g||j||!i?e.jsx(Ce,{}):r||m||y?e.jsxs("p",{className:"text-center text-red-500",children:["Error:"," ",(r==null?void 0:r.message)||(m==null?void 0:m.message)||(y==null?void 0:y.message)]}):h?l?e.jsx(pe,{...s,children:e.jsxs("form",{className:"max-w-2xl",onSubmit:s.handleSubmit(q),children:[e.jsx("div",{className:"w-full grid gap-2",children:e.jsx(I,{control:s.control,name:"bin_id",render:({field:d})=>e.jsxs(F,{children:[e.jsx(k,{children:"Bin"}),e.jsx(Q,{items:C(),onValueChange:d.onChange,placeholder:"Select a bin",value:d.value}),e.jsx(w,{})]})})}),e.jsxs("div",{className:"w-full grid gap-2 mt-4",children:[e.jsx(I,{control:s.control,name:"inventory_id",render:({field:d})=>e.jsxs(F,{children:[e.jsx(k,{children:"Inventory"}),e.jsx(ht,{countType:i.count_type.id,onValueChange:E=>{o(E),d.onChange(E.header_code)},storeName:i.store.name,value:d.value}),e.jsx(w,{})]})}),c&&e.jsxs("div",{className:"mt-2 flex items-center text-red-600",children:[e.jsx(ke,{className:"mr-2 h-5 w-5"}),e.jsx("p",{children:"Warning: This item has already been counted in the same bin!"})]})]}),n&&e.jsx($,{alt:"preview inventory image",className:"mt-4 w-56 h-56 bg-gray-200",src:M(n.id)}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:s.control,name:"quantity",render:({field:d})=>e.jsxs(F,{className:"w-full",children:[e.jsx(k,{children:"Quantity"}),e.jsx(O,{children:e.jsx(ge,{placeholder:"Quantity",type:"number",...d,value:d.value??"",onChange:E=>d.onChange(E.target.valueAsNumber),required:!0})}),e.jsx(w,{})]})})}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:s.control,name:"unit_id",render:({field:d})=>e.jsxs(F,{children:[e.jsx(k,{children:"Unit"}),e.jsx(Q,{items:l??[],onValueChange:d.onChange,placeholder:"Select a unit",value:d.value}),e.jsx(w,{})]})})}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:s.control,name:"comments",render:({field:d})=>e.jsxs(F,{children:[e.jsx(k,{children:"Comments"}),e.jsx(Fe,{placeholder:"Comments",...d,onChange:d.onChange}),e.jsx(w,{})]})})}),e.jsx("div",{className:"w-full grid gap-2 mt-4",children:e.jsx(I,{control:s.control,name:"is_damaged",render:({field:d})=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{children:e.jsx(qe,{checked:d.value,onCheckedChange:d.onChange})}),e.jsx(ye,{className:"ml-1",htmlFor:"is_damaged",children:"is damaged"}),e.jsx(w,{})]})})}),e.jsxs("div",{className:"w-full flex gap-2 mt-8",children:[e.jsx(D,{disabled:s.formState.isSubmitting,label:"Clear",onClick:x,variant:"outline"}),e.jsx(D,{className:"w-full",isLoading:s.formState.isSubmitting,label:"Save",loadingLabel:"Saving...",type:"submit"})]})]})}):e.jsx("p",{className:"text-red-500",children:"Can't fetch units data."}):e.jsx("p",{className:"text-red-500",children:"Can't fetch bins data."});return e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[_(),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Create a new count detail."}),i?e.jsx("div",{className:"text-sm text-muted-foreground flex items-center gap-2",children:e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700",children:i.store.name})}):e.jsx(W,{className:"w-40 h-4 rounded-md"})]})}),e.jsx("div",{children:A()})]})}export{Mt as component};
