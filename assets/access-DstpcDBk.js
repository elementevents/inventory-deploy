import{r as x,j as e,N as $,Q as L,B as y,U as T,V as U,W as R,X as B,Y as M,Z as Q,_ as q,az as z,x as O,s as b,b as A,n as G,a_ as K,a4 as H,a5 as V,a6 as X,F as Z,a7 as W,a8 as Y,a9 as J,o as ee,p as se,t as ae,v as te,aa as ne,g as re,h as oe,i as ce,D as ie,a$ as v,z as le,L as ue}from"./index-D0UzDXdb.js";import{t as de}from"./zod-fFyjxTVb.js";import{B as me}from"./Button-fnRQMAsf.js";import{C as he}from"./chevrons-up-down-BGID-bGd.js";import{D as S,a as D,q as N}from"./constants-BmjxfpbN.js";import{C as pe}from"./circle-plus-I0ki6lX-.js";import{e as xe}from"./exportAllServerSide-C8VwC7Gv.js";import{D as _,c as fe,u as ge,s as je,b as ye,a as Ce}from"./tableSortMapper-CSDzbaka.js";import{u as _e,S as w}from"./skeleton-DTNZejXw.js";import{u as we}from"./useCount-B5Xn7iEM.js";import{a as Ne}from"./useUsers-DOqQzhph.js";import{D as be}from"./download-DZIx6H2S.js";import"./counts-SqIoWuzr.js";import"./users-CwLYKNY1.js";function ve({onValueChange:o,value:s,users:n}){const[r,c]=x.useState(!1),[u,a]=x.useState(""),i=()=>{const t="Select user...";if(!s)return t;const d=n.find(m=>m.id===s);return d?`[${d.employee_number}] ${d.first_name} ${d.last_name}`:t},h=n.filter(t=>`${t.employee_number} ${t.first_name} ${t.last_name}`.toLowerCase().includes(u.toLowerCase()));return e.jsxs($,{open:r,onOpenChange:c,children:[e.jsx(L,{asChild:!0,children:e.jsxs(y,{variant:"outline",role:"combobox","aria-expanded":r,className:"w-full justify-between",children:[i(),e.jsx(he,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(T,{className:"w-[var(--radix-popover-trigger-width)] p-0",children:e.jsxs(U,{shouldFilter:!1,children:[e.jsx(R,{placeholder:"Search user...",value:u,onValueChange:a}),e.jsxs(B,{children:[e.jsx(M,{children:"No user found."}),e.jsx(Q,{children:h.map(t=>e.jsxs(q,{value:t.id,onSelect:d=>{d!==s&&o(d),c(!1)},children:[e.jsx(z,{className:O("mr-2 h-4 w-4",s===t.id?"opacity-100":"opacity-0")}),`[${t.employee_number}] ${t.first_name} ${t.last_name}`]},t.id))})]})]})})]})}async function Ae(o,{pageIndex:s=S,pageSize:n=D,q:r,sortBy:c}){const u=s*n,a=u+n-1;let i=b.from("user_count_accesses").select(`
        id,
        user:user_id (
          id,
          email,
          employee_number,
          first_name,
          last_name
        ),
        count_id
        `,{count:"exact"}).eq("count_id",o).range(u,a);r&&r.trim()&&(i=i.or(`employee_number.ilike.%${r}%,last_name.ilike.%${r}%,first_name.ilike.%${r}%`)),c&&c.length>0?c.split(",").forEach(m=>{const[f,g]=m.split("."),C=f;i=i.order(C,{ascending:g==="asc"})}):i=i.order("user(employee_number)",{ascending:!0});const{data:h,error:t,count:d}=await i;if(t)throw t;return{result:h,total:d??0}}async function Se(o,s){const{data:n,error:r}=await b.from("user_count_accesses").insert({count_id:o,...s}).select(`
        id,
        user:user_id (
          id,
          email,
          employee_number,
          first_name,
          last_name
        ),
        count_id
        `).single();if(r)throw r;return n}async function De(o){const{error:s}=await b.from("user_count_accesses").delete().eq("id",o);if(s)throw s}function Fe({countId:o,onAccessCreated:s,users:n}){const[r,c]=x.useState(!1),[u,a]=x.useState(!1),{toast:i}=A(),h=G({defaultValues:{user_id:""},resolver:de(K)});async function t(m){try{c(!0);const f=await Se(o,m);s(f),a(!1),h.reset(),i({title:"Access granted",description:"The user has been granted access to the count."})}catch{i({title:"Error",description:"Failed to grant access. Please try again.",variant:"destructive"})}finally{c(!1)}}const d=m=>{r||(a(m),m||h.reset())};return e.jsxs(H,{open:u,onOpenChange:d,children:[e.jsx(V,{asChild:!0,children:e.jsxs(y,{className:"h-8 gap-1",size:"sm",onClick:()=>a(!0),children:[e.jsx(pe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only sm:not-sr-only sm:whitespace-nowrap",children:"Add access"})]})}),e.jsx(X,{className:"sm:max-w-md",children:e.jsx(Z,{...h,children:e.jsxs("form",{className:"space-y-4",onSubmit:h.handleSubmit(t),children:[e.jsxs(W,{children:[e.jsx(Y,{children:"Add access"}),e.jsx(J,{children:"Select the user you want to grant access to the count."})]}),e.jsx(ee,{control:h.control,name:"user_id",render:({field:m})=>e.jsxs(se,{children:[e.jsx(ae,{children:e.jsx(ve,{onValueChange:m.onChange,users:n,value:m.value})}),e.jsx(te,{})]})}),e.jsx(ne,{className:"sm:justify-start",children:e.jsx(me,{isLoading:r,label:"Grant access",loadingLabel:"Granting access...",type:"submit"})})]})})})]})}function Ee(o,s){return _e({queryKey:N.userCountAccesses.list(s),queryFn:()=>Ae(o,s)})}const ke=({onAccessRevoked:o})=>[{accessorKey:"employee_number",header:({column:s})=>e.jsx(_,{column:s,title:"Employee #"}),cell:({row:s})=>{const n=s.original.user.employee_number;return e.jsx("div",{className:"max-w-[100px] font-medium",children:n})}},{accessorKey:"fullName",header:({column:s})=>e.jsx(_,{column:s,title:"Full Name"}),cell:({row:s})=>{const n=s.original.user.first_name,r=s.original.user.last_name;return e.jsx("div",{className:"max-w-[300px] truncate font-medium",children:`${n} ${r}`})}},{accessorKey:"email",header:({column:s})=>e.jsx(_,{column:s,title:"Email"}),cell:({row:s})=>e.jsx("div",{className:"max-w-[300px] truncate",children:s.original.user.email})},{id:"actions",cell:({row:s})=>e.jsx(Ie,{onAccessRevoked:o,row:s})}];function Ie({onAccessRevoked:o,row:s}){const[n,r]=x.useState(!1),{toast:c}=A();async function u(){if(!n)try{r(!0),await De(s.original.id),o(s.original.id),c({title:"Access Revoked",description:"The user's access has been revoked successfully."})}catch{c({title:"Error",description:"Failed to revoke access. Please try again.",variant:"destructive"})}finally{r(!1)}}return e.jsxs(re,{children:[e.jsx(oe,{asChild:!0,children:e.jsxs(y,{variant:"ghost",className:"flex h-8 w-8 p-0 data-[state=open]:bg-muted ml-auto",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Open menu"})]})}),e.jsx(ce,{align:"end",className:"w-[160px]",children:e.jsx(ie,{className:"text-red-600 hover:text-red-600 focus:text-red-600",onClick:u,children:"Revoke access"})})]})}function He(){const[o,s]=x.useState(!1),{id:n}=v.useParams(),r=le(),{filters:c,setFilters:u}=ge(v.id),{data:a,isLoading:i}=Ee(n,c),{data:h}=we(n),{data:t,isLoading:d}=Ne(),m=x.useMemo(()=>(t==null?void 0:t.filter(l=>{var p;return!((p=a==null?void 0:a.result)!=null&&p.some(j=>j.user.id===l.id))}))??[],[t,a]),f={pageIndex:c.pageIndex??S,pageSize:c.pageSize??D},g=je(c.sortBy);function C(l){const p=[...(a==null?void 0:a.result)??[],l];r.setQueryData(N.userCountAccesses.forCount(n),p)}function F(l){var j;const p=((j=a==null?void 0:a.result)==null?void 0:j.filter(P=>P.id!==l))||[];r.setQueryData(N.userCountAccesses.forCount(n),p)}const E=()=>h?e.jsxs("h3",{className:"text-2xl font-semibold leading-none tracking-tight",children:['"',h.name,'" accesses']}):e.jsx(w,{className:"w-52 h-8 rounded-md"}),k=()=>i?e.jsx(w,{className:"w-20 h-5 rounded-md"}):e.jsxs(y,{className:"ml-auto h-8 gap-1",onClick:async()=>{if(!o)try{s(!0),await xe("user_count_accesses",{countId:n})}finally{s(!1)}},size:"sm",variant:"outline",disabled:o,children:[o?e.jsx(ue,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(be,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only sm:not-sr-only sm:whitespace-nowrap",children:o?"Exportingâ€¦":"Export All"})]}),I=()=>d?e.jsx(w,{className:"w-[80px] h-[20px] rounded-full"}):e.jsx(Fe,{countId:n,onAccessCreated:C,users:m});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex flex-col space-y-1.5",children:[E(),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage the access of the count"})]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[k(),I()]})]}),e.jsx(ye,{columns:ke({onAccessRevoked:F}),data:(a==null?void 0:a.result)??[],filterPlaceholder:"Search users...",isLoading:i,searchValue:c.q??"",onSearchFieldChange:l=>{u({q:l,pageIndex:0})},onSortingChange:l=>{const p=typeof l=="function"?l(g):l;return u({sortBy:Ce(p)})},pagination:f,paginationOptions:{onPaginationChange:l=>{u(typeof l=="function"?l(f):l)},rowCount:a==null?void 0:a.total},sorting:g})]})}export{He as component};
